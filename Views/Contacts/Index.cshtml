@model IEnumerable<FastFood.Models.LienHe>

@{
    ViewBag.Title = "Quản Lý Phản Hồi";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    .card-header-custom {
        background: linear-gradient(45deg, #ffbe33, #e69c00);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 15px 25px;
    }

    /* Giới hạn độ dài nội dung hiển thị trong bảng */
    .text-truncate-custom {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .btn-action {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: none;
        margin: 0 2px;
    }

    .btn-view {
        background: #e0f2f1;
        color: #00695c;
    }

    .btn-reply {
        background: #e3f2fd;
        color: #0d47a1;
    }

    .btn-delete {
        background: #ffebee;
        color: #c62828;
    }

    /* Style cho nút trạng thái */
    .btn-status {
        width: 40px;
        height: 25px;
        padding: 0;
        font-size: 14px;
        line-height: 25px;
        border-radius: 15px;
        transition: all 0.3s;
    }
</style>

<div class="card shadow border-0" style="border-radius: 15px;">
    <div class="card-header-custom d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold"><i class="fas fa-envelope me-2"></i> DANH SÁCH PHẢN HỒI</h5>
    </div>

    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table align-middle mb-0 table-hover">
                <thead class="bg-light text-secondary">
                    <tr>
                        <th class="ps-4">Người gửi</th>
                        <th>Chủ đề</th>
                        <th>Nội dung tóm tắt</th>
                        <th>Ngày gửi</th>
                        <th class="text-center">Hiển thị</th>
                        <th class="text-end pe-4">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold">@item.HoTen</div>
                                    <small class="text-muted">@item.Email</small>
                                </td>
                                <td><span class="badge bg-light border text-dark">@item.ChuDe</span></td>
                                <td>
                                    <div class="text-truncate-custom" title="@item.NoiDung">@item.NoiDung</div>
                                </td>
                                <td>
                                    @if (item.NgayTao.HasValue)
                                    {
                                        <i class="far fa-clock me-1 text-muted"></i> @item.NgayTao.Value.ToString("dd/MM/yyyy")
                                    }
                                </td>

                                <td class="text-center">
                                    <button class="btn btn-status @(item.TrangThai == true ? "btn-success" : "btn-secondary")"
                                            onclick="toggleStatus(this, @item.MaLienHe)"
                                            title="Bấm để thay đổi trạng thái">
                                        <i class="fas @(item.TrangThai == true ? "fa-check" : "fa-minus")"></i>
                                    </button>
                                </td>

                                <td class="text-end pe-4">
                                    <button type="button" class="btn-action btn-view" title="Xem chi tiết"
                                            onclick="showContact('@item.HoTen', '@item.Email', '@item.ChuDe', '@HttpUtility.JavaScriptStringEncode(item.NoiDung)', '@item.NgayTao')">
                                        <i class="fas fa-eye"></i>
                                    </button>

                                    <a href="mailto:@item.Email?subject=Phản hồi: @item.ChuDe" class="btn-action btn-reply" title="Trả lời qua Email">
                                        <i class="fas fa-reply"></i>
                                    </a>

                                    <form action="@Url.Action("Delete", "Contacts")" method="post" style="display:inline;">
                                        <input type="hidden" name="id" value="@item.MaLienHe" />
                                        <button type="submit" class="btn-action btn-delete" title="Xóa" onclick="return confirm('Bạn có chắc muốn xóa tin nhắn này?');">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3 d-block text-gray-300"></i>
                                Chưa có phản hồi nào!
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="contactModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title fw-bold">Chi tiết tin nhắn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3 border-bottom pb-2">
                    <small class="text-muted">Người gửi:</small>
                    <h5 class="fw-bold mb-0 text-dark" id="mName"></h5>
                    <span class="text-primary" id="mEmail"></span>
                </div>

                <div class="mb-3">
                    <small class="text-muted">Chủ đề:</small>
                    <p class="fw-bold text-dark" id="mSubject"></p>
                </div>

                <div class="p-3 bg-light rounded">
                    <small class="text-muted mb-1 d-block">Nội dung:</small>
                    <p class="mb-0 text-dark" id="mContent" style="white-space: pre-line;"></p>
                </div>

                <div class="text-end mt-2">
                    <small class="text-muted" id="mDate"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        // Hàm hiển thị chi tiết tin nhắn
        function showContact(name, email, subject, content, date) {
            $('#mName').text(name);
            $('#mEmail').text(email);
            $('#mSubject').text(subject);
            $('#mContent').text(content);
            $('#mDate').text('Gửi lúc: ' + date);

            // Dùng jQuery gọi modal BS5 vẫn ok nếu đã load bootstrap.bundle.js
            $('#contactModal').modal('show');
        }

        // Hàm xử lý Bật/Tắt hiển thị (AJAX)
        function toggleStatus(btn, id) {
            var url = '@Url.Action("ToggleStatus", "Contacts")';

            $.post(url, { id: id }, function (res) {
                if (res.success) {
                    var icon = $(btn).find('i');
                    if (res.status) {
                        // Trạng thái: Hiện
                        $(btn).removeClass('btn-secondary').addClass('btn-success');
                        icon.removeClass('fa-minus').addClass('fa-check');

                        const Toast = Swal.mixin({
                            toast: true, position: 'top-end', showConfirmButton: false, timer: 1500
                        });
                        Toast.fire({ icon: 'success', title: 'Đã hiển thị lên trang chủ' });
                    } else {
                        // Trạng thái: Ẩn
                        $(btn).removeClass('btn-success').addClass('btn-secondary');
                        icon.removeClass('fa-check').addClass('fa-minus');
                    }
                } else {
                    var msg = res.message ? res.message : 'Không thể cập nhật trạng thái';
                    Swal.fire('Lỗi', msg, 'error');
                }
            }).fail(function (xhr, status, error) {
                Swal.fire('Lỗi Server', 'Mã lỗi: ' + xhr.status + ' - ' + xhr.statusText, 'error');
            });
        }
    </script>
}